<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„íŠ¸ ì„¸í¬ë§‰ íˆ¬ê³¼ì„± ë¶„ì„ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        #canvas-container {
            position: relative;
            cursor: crosshair;
            max-width: 100%;
            overflow: hidden;
            border: 2px dashed #e2e8f0;
            border-radius: 1.25rem;
            background-color: #f8fafc;
            min-height: 450px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #canvas-container:hover {
            border-color: #3b82f6;
            background-color: #f1f5f9;
        }
        canvas#imageCanvas {
            display: block;
            margin: 0 auto;
            border-radius: 0.75rem;
            max-width: 100%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .temp-selection {
            position: absolute;
            border: 2px dashed #3b82f6;
            background-color: rgba(59, 130, 246, 0.15);
            pointer-events: none;
            z-index: 10;
        }
        .fixed-selection {
            position: absolute;
            border: 2px solid;
            background-color: rgba(255, 255, 255, 0.05);
            pointer-events: none;
            z-index: 5;
            backdrop-filter: blur(1px);
        }
        .selection-label {
            position: absolute;
            top: -24px;
            left: -2px;
            font-size: 11px;
            font-weight: 700;
            color: white;
            padding: 2px 8px;
            border-radius: 6px 6px 0 0;
            white-space: nowrap;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        .data-value {
            display: block;
            width: 100%;
            height: 100%;
            padding: 10px 4px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 6px;
        }
        .data-value:hover {
            background-color: #fff1f2;
            color: #e11d48;
            text-decoration: line-through;
        }
        .slot-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .slot-btn.active {
            background-color: #1e293b;
            color: white;
            border-color: #1e293b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2);
        }
        .chart-wrapper {
            position: relative;
            height: 420px;
            width: 100%;
        }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-10 text-slate-900">
    <div id="loadingOverlay" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-bold text-slate-700">ì„œë²„ì™€ í†µì‹  ì¤‘...</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-10 text-center flex flex-col items-center">
            <span class="inline-block px-4 py-1.5 mb-2 text-[10px] font-extrabold tracking-widest text-blue-600 uppercase bg-blue-50 rounded-full">Biological Analysis System</span>
            <div class="text-xs font-bold text-slate-400 mb-1 tracking-tight">ì—¬ìˆ˜ê³ ë“±í•™êµ ìƒëª…ê³¼í•™ì‹¤í—˜</div>
            <div class="text-[11px] font-bold text-slate-500 mb-4 tracking-wider">ì„œì˜ˆì¤€ ì˜¤ì‹œí›„</div>
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">ë¹„íŠ¸ ì„¸í¬ë§‰ íˆ¬ê³¼ì„± ë¶„ì„ê¸°</h1>
            <p class="text-slate-500 mt-3 font-medium max-w-2xl mx-auto text-center">ì‹¤í—˜ ì´ë¯¸ì§€ì—ì„œ ìƒ‰ë†ë„ë¥¼ ì •ë°€í•˜ê²Œ ì¶”ì¶œí•˜ì—¬ ì„¸í¬ë§‰ì˜ íˆ¬ê³¼ì„± ë³€í™”ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-7 space-y-8">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col">
                    <div class="flex flex-wrap items-center justify-between mb-8 gap-4">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="window.switchSlot(0)" id="slotBtn0" class="slot-btn active px-5 py-2.5 border border-slate-200 rounded-2xl text-xs font-bold transition">10ë¶„</button>
                            <button onclick="window.switchSlot(1)" id="slotBtn1" class="slot-btn px-5 py-2.5 border border-slate-200 rounded-2xl text-xs font-bold transition">15ë¶„</button>
                            <button onclick="window.switchSlot(2)" id="slotBtn2" class="slot-btn px-5 py-2.5 border border-slate-200 rounded-2xl text-xs font-bold transition">20ë¶„</button>
                            <button onclick="window.switchSlot(3)" id="slotBtn3" class="slot-btn px-5 py-2.5 border border-slate-200 rounded-2xl text-xs font-bold transition">24ì‹œê°„</button>
                        </div>
                        <div class="flex gap-3">
                            <input type="file" id="imageInput" accept="image/*" class="hidden">
                            <label for="imageInput" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2.5 rounded-2xl cursor-pointer transition text-xs shadow-md font-bold flex items-center">
                                ì‚¬ì§„ ì—…ë¡œë“œ
                            </label>
                            <button id="clearCurrentSlot" class="text-xs text-rose-500 hover:bg-rose-50 px-4 py-2.5 rounded-2xl transition font-bold border border-rose-100">ìŠ¬ë¡¯ ë¹„ìš°ê¸°</button>
                        </div>
                    </div>

                    <div id="canvas-container">
                        <div id="placeholder" class="text-slate-400 text-center select-none p-10 flex flex-col items-center">
                            <div class="bg-white w-24 h-24 rounded-3xl flex items-center justify-center mb-6 shadow-sm border border-slate-100 rotate-3 transition hover:rotate-0">
                                <span class="text-5xl">ğŸ”¬</span>
                            </div>
                            <p class="text-xl font-bold text-slate-700">ë¶„ì„ ëŒ€ê¸° ì¤‘</p>
                            <p class="text-sm text-slate-400 mt-2">ìƒë‹¨ì—ì„œ ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•˜ê³  ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                        </div>
                        <div id="activeImageWrapper" class="relative hidden">
                            <canvas id="imageCanvas"></canvas>
                            <div id="tempBox" class="temp-selection hidden"></div>
                            <div id="fixedBoxesContainer" class="absolute inset-0 pointer-events-none"></div>
                        </div>
                    </div>
                </div>

                <!-- Cloud Persistence Controls -->
                <div class="bg-slate-900 p-8 rounded-3xl shadow-xl flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-4">
                        <div class="bg-blue-500/20 p-3 rounded-2xl">
                            <span class="text-2xl">â˜ï¸</span>
                        </div>
                        <div>
                            <h3 class="text-white font-bold">ì‹¤í—˜ ë°ì´í„° ì„œë²„ ë³´ê´€</h3>
                            <p class="text-slate-400 text-xs text-center md:text-left">í˜„ì¬ ëª¨ë“  ì‚¬ì§„ê³¼ ê¸°ë¡ì„ ì„œë²„ì— ì˜êµ¬ ì €ì¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 w-full md:w-auto">
                        <button id="saveToServer" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-2xl font-bold text-sm transition">
                            ì„œë²„ì— ì €ì¥í•˜ê¸°
                        </button>
                        <button id="loadFromServer" class="flex-1 md:flex-none bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-2xl font-bold text-sm transition border border-slate-700">
                            ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>
                        <button id="resetAllData" class="flex-1 md:flex-none bg-rose-600 hover:bg-rose-500 text-white px-6 py-3 rounded-2xl font-bold text-sm transition">
                            ì „ì²´ ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 flex flex-col space-y-8">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                    <div class="flex flex-col space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-extrabold text-slate-400 mb-2 uppercase tracking-wider text-center lg:text-left">ìš©ì•¡ ì¢…ë¥˜</label>
                                <select id="solutionSelect" class="block w-full border border-slate-100 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50 font-bold outline-none cursor-pointer appearance-none text-center">
                                    <option value="ì¦ë¥˜ìˆ˜">ì¦ë¥˜ìˆ˜</option>
                                    <option value="ì£¼ë°©ì„¸ì œ">ì£¼ë°©ì„¸ì œ</option>
                                    <option value="ë² ì´í‚¹ì†Œë‹¤">ë² ì´í‚¹ì†Œë‹¤</option>
                                    <option value="ê³¼íƒ„ì‚°ì†Œë‹¤">ê³¼íƒ„ì‚°ì†Œë‹¤</option>
                                    <option value="ì„¸íƒì„¸ì œ">ì„¸íƒì„¸ì œ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-extrabold text-slate-400 mb-2 uppercase tracking-wider text-center lg:text-left">ì‹œê°„</label>
                                <select id="timeSelect" class="block w-full border border-slate-100 rounded-2xl p-3.5 text-sm focus:ring-2 focus:ring-blue-500 bg-slate-50 font-bold outline-none cursor-pointer appearance-none text-center">
                                    <option value="10ë¶„">10ë¶„</option>
                                    <option value="15ë¶„">15ë¶„</option>
                                    <option value="20ë¶„">20ë¶„</option>
                                    <option value="24ì‹œê°„">24ì‹œê°„</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-extrabold text-slate-400 mb-2 uppercase tracking-wider text-center lg:text-left">ì‹¤ì‹œê°„ ì¸¡ì • (R: íˆ¬ê³¼ì„± ì§€í‘œ)</label>
                            <div class="flex gap-2">
                                <div id="rDisplay" class="flex-1 bg-white p-4 rounded-2xl text-center font-mono text-sm border-2 border-rose-100 text-rose-600 font-extrabold">R: 0</div>
                                <div id="gDisplay" class="flex-1 bg-white p-4 rounded-2xl text-center font-mono text-sm border-2 border-emerald-100 text-emerald-600 font-extrabold">G: 0</div>
                                <div id="bDisplay" class="flex-1 bg-white p-4 rounded-2xl text-center font-mono text-sm border-2 border-blue-100 text-blue-600 font-extrabold">B: 0</div>
                            </div>
                        </div>

                        <button id="addRecord" class="bg-slate-900 hover:bg-black text-white px-4 py-4 rounded-2xl transition shadow-xl font-bold text-sm w-full">
                            ì´ ê²°ê³¼ë¥¼ ì‹¤í—˜ ë¡œê·¸ì— ê¸°ë¡
                        </button>
                    </div>

                    <div class="mt-8">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm font-extrabold text-slate-800">ì‹¤í—˜ ë¡œê·¸</h2>
                            <select id="filterSolution" class="text-[10px] border border-slate-200 rounded-xl px-2 py-1 bg-slate-50 font-bold outline-none">
                                <option value="all">ì „ì²´</option>
                                <option value="ì¦ë¥˜ìˆ˜">ì¦ë¥˜ìˆ˜</option>
                                <option value="ì£¼ë°©ì„¸ì œ">ì£¼ë°©ì„¸ì œ</option>
                                <option value="ë² ì´í‚¹ì†Œë‹¤">ë² ì´í‚¹ì†Œë‹¤</option>
                                <option value="ê³¼íƒ„ì‚°ì†Œë‹¤">ê³¼íƒ„ì‚°ì†Œë‹¤</option>
                                <option value="ì„¸íƒì„¸ì œ">ì„¸íƒì„¸ì œ</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto rounded-2xl border border-slate-100">
                            <table class="w-full text-[11px] border-collapse">
                                <thead>
                                    <tr class="bg-slate-50/50 border-b border-slate-100">
                                        <th class="py-3 px-3 text-left text-slate-400 font-extrabold">ìš©ì•¡</th>
                                        <th class="py-3 px-1 text-center text-slate-400 font-extrabold">10m</th>
                                        <th class="py-3 px-1 text-center text-slate-400 font-extrabold">15m</th>
                                        <th class="py-3 px-1 text-center text-slate-400 font-extrabold">20m</th>
                                        <th class="py-3 px-1 text-center text-slate-400 font-extrabold">24h</th>
                                        <th class="py-3 px-3"></th>
                                    </tr>
                                </thead>
                                <tbody id="horizontalTableBody" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex-grow">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-xl font-extrabold text-slate-800 text-center lg:text-left w-full">íˆ¬ê³¼ì„± ë³€í™” ê³¡ì„ </h2>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="resultChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bit-permeability-analysis';
        
        let currentUser = null;

        // UI Elements
        const imageInput = document.getElementById('imageInput');
        const canvas = document.getElementById('imageCanvas');
        const activeImageWrapper = document.getElementById('activeImageWrapper');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const tempBox = document.getElementById('tempBox');
        const fixedBoxesContainer = document.getElementById('fixedBoxesContainer');
        const placeholder = document.getElementById('placeholder');
        const rDisplay = document.getElementById('rDisplay');
        const gDisplay = document.getElementById('gDisplay');
        const bDisplay = document.getElementById('bDisplay');
        const timeSelect = document.getElementById('timeSelect');
        const horizontalTableBody = document.getElementById('horizontalTableBody');
        const filterSolution = document.getElementById('filterSolution');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const timeOrder = ['10ë¶„', '15ë¶„', '20ë¶„', '24ì‹œê°„'];
        const solutionOrder = ['ì¦ë¥˜ìˆ˜', 'ì£¼ë°©ì„¸ì œ', 'ë² ì´í‚¹ì†Œë‹¤', 'ê³¼íƒ„ì‚°ì†Œë‹¤', 'ì„¸íƒì„¸ì œ'];
        const solutionColors = {
            'ì¦ë¥˜ìˆ˜': '#64748b', 'ì£¼ë°©ì„¸ì œ': '#0ea5e9', 'ë² ì´í‚¹ì†Œë‹¤': '#f59e0b',
            'ê³¼íƒ„ì‚°ì†Œë‹¤': '#8b5cf6', 'ì„¸íƒì„¸ì œ': '#f43f5e'
        };

        // State
        let currentSlot = 0;
        let slots = Array.from({ length: 4 }, () => ({ imgData: null, boxes: [] }));
        let experimentData = [];
        let currentRGB = { r: 0, g: 0, b: 0 };
        let isDragging = false;
        let startX, startY;

        // Auth initialization
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            }
        });

        // Chart Setup
        Chart.defaults.font.family = "'Inter', 'Apple SD Gothic Neo', sans-serif";
        Chart.defaults.color = '#94a3b8';
        const chartCtx = document.getElementById('resultChart').getContext('2d');
        const resultChart = new Chart(chartCtx, {
            type: 'line',
            data: {
                labels: timeOrder,
                datasets: solutionOrder.map(name => ({
                    label: name,
                    data: [null, null, null, null],
                    borderColor: solutionColors[name],
                    backgroundColor: solutionColors[name] + '10',
                    borderWidth: 4,
                    tension: 0.4,
                    pointRadius: 6,
                    pointBackgroundColor: '#fff',
                    pointBorderWidth: 3,
                    fill: true
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { reverse: true, min: 0, max: 255, title: { display: true, text: 'R Intensity (Redness)' } }
                }
            }
        });

        // Core Functions
        window.switchSlot = function(index) {
            currentSlot = index;
            document.querySelectorAll('.slot-btn').forEach((btn, idx) => btn.classList.toggle('active', idx === index));
            timeSelect.value = timeOrder[index];
            renderCanvas();
        };

        async function renderCanvas() {
            const slot = slots[currentSlot];
            fixedBoxesContainer.innerHTML = '';
            
            if (!slot.imgData) {
                activeImageWrapper.classList.add('hidden');
                placeholder.classList.remove('hidden');
                rDisplay.innerText = 'R: 0'; gDisplay.innerText = 'G: 0'; bDisplay.innerText = 'B: 0';
                currentRGB = { r: 0, g: 0, b: 0 };
                return;
            }

            activeImageWrapper.classList.remove('hidden');
            placeholder.classList.add('hidden');

            const img = new Image();
            img.onload = () => {
                const container = document.getElementById('canvas-container');
                // Calculate display size
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                
                const imgAspect = img.width / img.height;
                const containerAspect = containerWidth / containerHeight;
                
                let displayWidth, displayHeight;
                
                // Fit image to container while maintaining aspect ratio
                if (imgAspect > containerAspect) {
                    displayWidth = Math.min(img.width, containerWidth - 40);
                    displayHeight = displayWidth / imgAspect;
                } else {
                    displayHeight = Math.min(img.height, containerHeight - 40);
                    displayWidth = displayHeight * imgAspect;
                }
                
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.style.width = displayWidth + "px";
                canvas.style.height = displayHeight + "px";

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                // Position the wrapper centrally in container
                activeImageWrapper.style.width = displayWidth + "px";
                activeImageWrapper.style.height = displayHeight + "px";
                
                slot.boxes.forEach(box => createBoxElement(box));
            };
            img.src = slot.imgData;
        }

        function createBoxElement(box) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;

            const boxEl = document.createElement('div');
            boxEl.className = 'fixed-selection';
            boxEl.style.left = (box.x * scaleX) + 'px'; 
            boxEl.style.top = (box.y * scaleY) + 'px'; 
            boxEl.style.width = (box.w * scaleX) + 'px'; 
            boxEl.style.height = (box.h * scaleY) + 'px';
            boxEl.style.borderColor = solutionColors[box.solution];
            
            const label = document.createElement('div');
            label.className = 'selection-label';
            label.style.backgroundColor = solutionColors[box.solution];
            label.innerText = box.solution;
            
            boxEl.appendChild(label);
            fixedBoxesContainer.appendChild(boxEl);
        }

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                slots[currentSlot].imgData = event.target.result;
                slots[currentSlot].boxes = [];
                renderCanvas();
            };
            reader.readAsDataURL(file);
            imageInput.value = ''; 
        });

        // Interaction
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (evt.clientX - rect.left) * scaleX,
                y: (evt.clientY - rect.top) * scaleY
            };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!slots[currentSlot].imgData) return;
            isDragging = true;
            const pos = getMousePos(e);
            startX = pos.x; startY = pos.y;
            tempBox.classList.remove('hidden');
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const pos = getMousePos(e);
            const l = Math.min(startX, pos.x);
            const t = Math.min(startY, pos.y);
            const w = Math.abs(pos.x - startX);
            const h = Math.abs(pos.y - startY);

            const rect = canvas.getBoundingClientRect();
            const sx = rect.width / canvas.width;
            const sy = rect.height / canvas.height;

            tempBox.style.width = (w * sx) + 'px';
            tempBox.style.height = (h * sy) + 'px';
            tempBox.style.left = (l * sx) + 'px';
            tempBox.style.top = (t * sy) + 'px';
            
            if (w > 1 && h > 1) {
                try {
                    const imageData = ctx.getImageData(l, t, Math.max(1, w), Math.max(1, h));
                    const data = imageData.data;
                    let rS = 0, gS = 0, bS = 0;
                    for (let i = 0; i < data.length; i += 4) {
                        rS += data[i]; gS += data[i+1]; bS += data[i+2];
                    }
                    const cnt = data.length / 4;
                    currentRGB = { r: Math.round(rS / cnt), g: Math.round(gS / cnt), b: Math.round(bS / cnt) };
                    rDisplay.innerText = `R: ${currentRGB.r}`;
                    gDisplay.innerText = `G: ${currentRGB.g}`;
                    bDisplay.innerText = `B: ${currentRGB.b}`;
                } catch (err) {}
            }
        });

        window.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            isDragging = false;
            const pos = getMousePos(e);
            const l = Math.min(startX, pos.x);
            const t = Math.min(startY, pos.y);
            const w = Math.abs(pos.x - startX);
            const h = Math.abs(pos.y - startY);

            if (w > 5 && h > 5) {
                const sol = document.getElementById('solutionSelect').value;
                slots[currentSlot].boxes = slots[currentSlot].boxes.filter(b => b.solution !== sol);
                slots[currentSlot].boxes.push({ x: l, y: t, w, h, solution: sol });
                renderCanvas();
            }
            tempBox.classList.add('hidden');
        });

        // Records & UI Update
        document.getElementById('addRecord').addEventListener('click', () => {
            if (currentRGB.r === 0 && currentRGB.g === 0) return;
            const time = document.getElementById('timeSelect').value;
            const sol = document.getElementById('solutionSelect').value;
            const idx = experimentData.findIndex(d => d.solution === sol && d.time === time);
            if (idx > -1) experimentData[idx] = { solution: sol, time, ...currentRGB };
            else experimentData.push({ solution: sol, time, ...currentRGB });
            updateUI();
        });

        window.deleteSingleEntry = (sol, time) => {
            experimentData = experimentData.filter(d => !(d.solution === sol && d.time === time));
            updateUI();
        };

        window.deleteRow = (sol) => {
            experimentData = experimentData.filter(d => d.solution !== sol);
            updateUI();
        };

        function updateUI() {
            horizontalTableBody.innerHTML = '';
            const solFilter = filterSolution.value;
            solutionOrder.forEach(solName => {
                if (solFilter !== 'all' && solFilter !== solName) return;
                const row = document.createElement('tr');
                let html = `<td class="py-3 px-3 font-extrabold" style="color:${solutionColors[solName]}">${solName}</td>`;
                timeOrder.forEach(timeLabel => {
                    const data = experimentData.find(d => d.solution === solName && d.time === timeLabel);
                    if (data) html += `<td class="text-center"><span class="data-value font-mono font-extrabold" onclick="window.deleteSingleEntry('${solName}', '${timeLabel}')">${data.r}</span></td>`;
                    else html += `<td class="text-center text-slate-200">-</td>`;
                });
                html += `<td class="py-3 px-3 text-right"><button onclick="window.deleteRow('${solName}')" class="text-slate-300 hover:text-rose-500">âœ•</button></td>`;
                row.innerHTML = html;
                horizontalTableBody.appendChild(row);
            });
            resultChart.data.datasets.forEach(dataset => {
                dataset.hidden = solFilter !== 'all' && dataset.label !== solFilter;
                dataset.data = timeOrder.map(label => {
                    const match = experimentData.find(d => d.solution === dataset.label && d.time === label);
                    return match ? match.r : null;
                });
            });
            resultChart.update();
        }

        filterSolution.addEventListener('change', updateUI);

        // Firestore Integration
        document.getElementById('saveToServer').addEventListener('click', async () => {
            if (!currentUser) return;
            loadingOverlay.style.display = 'flex';
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'experimentData', 'main_state');
                await setDoc(docRef, {
                    slots: slots,
                    experimentData: experimentData,
                    updatedAt: new Date().toISOString()
                });
            } catch (error) {
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        document.getElementById('loadFromServer').addEventListener('click', async () => {
            if (!currentUser) return;
            loadingOverlay.style.display = 'flex';
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'experimentData', 'main_state');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    slots = data.slots;
                    experimentData = data.experimentData;
                    updateUI();
                    renderCanvas();
                }
            } catch (error) {
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        document.getElementById('resetAllData').addEventListener('click', () => {
            slots = Array.from({ length: 4 }, () => ({ imgData: null, boxes: [] }));
            experimentData = [];
            updateUI();
            renderCanvas();
        });

        document.getElementById('clearCurrentSlot').addEventListener('click', () => {
            slots[currentSlot] = { imgData: null, boxes: [] };
            renderCanvas();
        });

        window.addEventListener('resize', renderCanvas);
    </script>
</body>
</html>
